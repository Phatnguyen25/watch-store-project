{% extends 'base.html' %} {% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-gray-900 mb-6 text-center">
    ğŸ“ TÃ¬m Cá»­a HÃ ng Gáº§n Báº¡n
  </h1>

  <div class="flex justify-center mb-8">
    <button
      onclick="findMyLocation()"
      class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center transition transform hover:scale-105"
    >
      <svg
        class="w-6 h-6 mr-2"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
        ></path>
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
        ></path>
      </svg>
      TÃ¬m cá»­a hÃ ng gáº§n nháº¥t
    </button>
  </div>

  <div
    id="result-box"
    class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6 text-center"
  >
    <p class="text-green-800 font-medium">
      ğŸ‰ ÄÃ£ tÃ¬m tháº¥y: <span id="store-name" class="font-bold"></span>
    </p>
    <p class="text-sm text-green-600">
      CÃ¡ch báº¡n: <span id="store-distance"></span> km
    </p>
  </div>

  <div
    id="map"
    class="w-full h-[500px] rounded-xl shadow-2xl border-4 border-white z-0"
  ></div>
</div>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // 1. Khá»Ÿi táº¡o báº£n Ä‘á»“ (Máº·c Ä‘á»‹nh á»Ÿ TP.HCM)
  var map = L.map("map").setView([10.7769, 106.7009], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap contributors",
  }).addTo(map);

  var userMarker, storeMarker;

  // 2. HÃ m xá»­ lÃ½ khi báº¥m nÃºt
  function findMyLocation() {
    if (!navigator.geolocation) {
      alert("TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ Ä‘á»‹nh vá»‹!");
      return;
    }

    // Hiá»‡n tráº¡ng thÃ¡i Ä‘ang tÃ¬m...
    document.getElementById("result-box").classList.remove("hidden");
    document.getElementById("store-name").innerText = "Äang quÃ©t...";

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // ÄÃ¡nh dáº¥u vá»‹ trÃ­ ngÆ°á»i dÃ¹ng (Icon Xanh)
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat, lng])
          .addTo(map)
          .bindPopup("Báº¡n Ä‘ang á»Ÿ Ä‘Ã¢y")
          .openPopup();

        // Gá»i API Backend Ä‘á»ƒ tÃ¬m cá»­a hÃ ng
        fetch(`/api/find-nearest/?lat=${lat}&lng=${lng}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.found) {
              // Hiá»ƒn thá»‹ káº¿t quáº£ text
              document.getElementById("store-name").innerText = data.name;
              document.getElementById("store-distance").innerText =
                data.distance_km;

              // ÄÃ¡nh dáº¥u cá»­a hÃ ng (Icon Äá» - Táº¡o icon riÃªng náº¿u muá»‘n)
              if (storeMarker) map.removeLayer(storeMarker);
              storeMarker = L.marker([data.lat, data.lng])
                .addTo(map)
                .bindPopup(`<b>${data.name}</b><br>${data.address}`)
                .openPopup();

              // Zoom báº£n Ä‘á»“ Ä‘á»ƒ tháº¥y cáº£ 2 Ä‘iá»ƒm
              var group = new L.featureGroup([userMarker, storeMarker]);
              map.fitBounds(group.getBounds().pad(0.1));
            } else {
              document.getElementById("store-name").innerText =
                "KhÃ´ng tÃ¬m tháº¥y cá»­a hÃ ng nÃ o!";
            }
          });
      },
      () => {
        alert("KhÃ´ng thá»ƒ láº¥y vá»‹ trÃ­. Vui lÃ²ng báº­t GPS!");
      },
    );
  }
</script>
{% endblock %}
